#!/bin/bash
#
GDOPTS="--no-header --absolute --max 100 --name-width 0"

TELL=
splitpath=1
recursive=

usage() {
  printf "\nUsage: gdrm [-n] [-r] [-s] [-u] path/to/fileorfolder [file2 ...]\n"
  exit 1
}

while getopts "nrsu" flag; do
    case $flag in
        n)
            TELL=1
            ;;
        r)
            recursive="--recursive"
            ;;
        s)
            splitpath=
            ;;
        u)
            usage
            ;;
    esac
done
shift $(( OPTIND - 1 ))

[ "$1" ] || {
  echo "rmfile requires at least one argument specifying folder or file to remove"
  exit 1
}

for file in $*
do
  base=${file}
  dir=
  parentid=
  parentquery=
  [ "${splitpath}" ] && {
    echo ${file} | grep '/' > /dev/null && {
      base=`basename ${file}`
      dir=`dirname ${file}`
      [ -f ${dir}/.folderid ] && {
        parentid=`cat ${dir}/.folderid`
        parentquery="and parents in '${parentid}'"
      }
    }
  }

  while read match
  do
    name=`echo ${match} | awk ' { print $2 } '`
    [ "${name}" == "${file}" ] && {
      fid=`echo ${match} | awk ' { print $1 } '`
      if [ "${TELL}" ]
      then
        echo "Would remove ${file} with id=${fid}"
      else
        gdrive delete ${recursive} ${fid}
      fi
    }
  done <<< `gdrive list ${GDOPTS} --query " name = '${base}' ${parentquery}"`
done
